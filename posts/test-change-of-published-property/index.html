<!DOCTYPE html><html><head><meta charset="UTF-8"/><meta name="og:site_name" content="dasdom"/><link rel="canonical" href="https://dasdom.dev/posts/test-change-of-published-property"/><meta name="twitter:url" content="https://dasdom.dev/posts/test-change-of-published-property"/><meta name="og:url" content="https://dasdom.dev/posts/test-change-of-published-property"/><title>Test The Publisher Of A @Published Property | dasdom</title><meta name="twitter:title" content="Test The Publisher Of A @Published Property | dasdom"/><meta name="og:title" content="Test The Publisher Of A @Published Property | dasdom"/><meta name="description" content="How to test the publisher of a @Published property."/><meta name="twitter:description" content="How to test the publisher of a @Published property."/><meta name="og:description" content="How to test the publisher of a @Published property."/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to dasdom"/></head><body class="item-page"><header><div class="wrapper"><a class="site-name" href="/">dasdom</a><nav><ul><li><a class="selected" href="/posts">Posts</a></li><li><a href="/books">Books</a></li><li><a href="/about">About</a></li><li><a href="/imprint">Imprint</a></li><li><a href="/privacy">Privacy</a></li></ul></nav></div></header><div class="wrapper"><p>22. Jul 2021</p><article><div class="content"><h1>Test The Publisher Of A @Published Property</h1><p><a href="https://twitter.com/johnsundell">John Sundell</a> wrote a <a href="https://www.swiftbysundell.com/articles/unit-testing-combine-based-swift-code/">blog post</a> about how to test Combine-based code. In the article he shows how to write unit tests for a publisher that tokenises a string. Great article as always and you should read it.</p><p>This blog post here is just a reminder for me how to change Johns <code>XCTestCase</code> extension to test the publisher of a <code>@Published</code> property. Without further ado here is the extension:</p><pre><code><span class="keyword">extension</span> <span class="type">XCTestCase</span> {
  <span class="keyword">func</span> _awaitPublishedChange&lt;T: <span class="type">Publisher</span>&gt;(
    <span class="keyword">_</span> publisher: <span class="type">T</span>,
    changeAction: () -&gt; <span class="type">Void</span> = {},
    timeout: <span class="type">TimeInterval</span> = <span class="number">1</span>,
    file: <span class="type">StaticString</span> = <span class="keyword">#file</span>,
    line: <span class="type">UInt</span> = <span class="keyword">#line</span>
  ) <span class="keyword">throws</span> -&gt; <span class="type">T</span>.<span class="type">Output</span> <span class="keyword">where</span> <span class="type">T</span>.<span class="type">Failure</span> == <span class="type">Never</span> {

    <span class="keyword">var</span> result: <span class="type">Result</span>&lt;<span class="type">T</span>.<span class="type">Output</span>, <span class="type">Error</span>&gt;?
    <span class="keyword">let</span> expectation = <span class="keyword">self</span>.<span class="call">expectation</span>(description: <span class="string">"Awaiting publisher"</span>)
  
    <span class="keyword">let</span> cancellable = publisher
      .<span class="call">dropFirst</span>()
      .<span class="call">sink</span>(receiveValue: { value <span class="keyword">in</span>
        result = .<span class="call">success</span>(value)
        expectation.<span class="call">fulfill</span>()
      })
    
    <span class="call">changeAction</span>()
    <span class="call">waitForExpectations</span>(timeout: timeout)
    cancellable.<span class="call">cancel</span>()
  
    <span class="keyword">let</span> unwrappedResult = <span class="keyword">try</span> <span class="type">XCTUnwrap</span>(
      result,
      <span class="string">"Awaited publisher did not produce any output"</span>,
      file: file,
      line: line
    )
  
    <span class="keyword">return try</span> unwrappedResult.<span class="call">get</span>()
  }
}
</code></pre><p>And this is how to use it:</p><pre><code><span class="keyword">func</span> test_addEvent_shouldPublishChangedEvents() <span class="keyword">throws</span> {
  <span class="keyword">let</span> fileManagerMock = <span class="type">FileManagerProtocolMock</span>()
  fileManagerMock.<span class="property">eventsURLReturnValue</span> = 
    <span class="call">documentsURL</span>(for: dummyEventsFilename)
  <span class="keyword">let</span> sut = <span class="type">EventStore</span>(fileManager: fileManagerMock)
  sut.<span class="property">events</span> = [<span class="type">Event</span>(name: <span class="string">"Bla"</span>, 
                      date: <span class="type">Date</span>(timeIntervalSinceNow: -<span class="number">1000</span>))]
  
  <span class="keyword">let</span> events = <span class="keyword">try</span> <span class="call">_awaitPublishedChange</span>(
    sut.<span class="property">$events</span>, 
    changeAction: { 
      sut.<span class="call">add</span>(<span class="type">Event</span>(name: <span class="string">"Foo"</span>, date: <span class="type">Date</span>()))
    })
  
  <span class="call">XCTAssertEqual</span>(events.<span class="property">count</span>, <span class="number">2</span>)
}
</code></pre></div><span>Tagged with: </span><ul class="tag-list"><li><a href="/tags/unittests">Unit-Tests</a></li><li><a href="/tags/tdd">TDD</a></li><li><a href="/tags/combine">Combine</a></li><li><a href="/tags/published">Published</a></li></ul></article></div><footer><p><a href="https://www.buymeacoffee.com/dasdom">Buy me a coffee</a></p><p><a href="/feed.rss">RSS feed</a><a> | </a><a href="https://twitter.com/dasdom">Twitter</a><a> | </a><a href="https://stackoverflow.com/users/498796/dasdom">StackOverflow</a><a> | </a><a href="https://github.com/dasdom">Github</a><a> | </a><a href="https://pragprog.com/titles/dhios/">My Book</a></p><p>Generated using <a href="https://github.com/johnsundell/publish">Publish</a></p></footer></body></html>