<!DOCTYPE html><html><head><meta charset="UTF-8"/><meta name="og:site_name" content="dasdom"/><link rel="canonical" href="https://dasdom.dev/posts/testing-uicollection_uicollection_view_compositional_layout_list"/><meta name="twitter:url" content="https://dasdom.dev/posts/testing-uicollection_uicollection_view_compositional_layout_list"/><meta name="og:url" content="https://dasdom.dev/posts/testing-uicollection_uicollection_view_compositional_layout_list"/><title>Testing a Custom UICollectionViewCompositionalLayout.list | dasdom</title><meta name="twitter:title" content="Testing a Custom UICollectionViewCompositionalLayout.list | dasdom"/><meta name="og:title" content="Testing a Custom UICollectionViewCompositionalLayout.list | dasdom"/><meta name="description" content="At WWDC 2020 Apple added a list layout to UICollectionView. This post explains how to write a unit tests that asserts that the cell is populated correctly."/><meta name="twitter:description" content="At WWDC 2020 Apple added a list layout to UICollectionView. This post explains how to write a unit tests that asserts that the cell is populated correctly."/><meta name="og:description" content="At WWDC 2020 Apple added a list layout to UICollectionView. This post explains how to write a unit tests that asserts that the cell is populated correctly."/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to dasdom"/></head><body class="item-page"><header><div class="wrapper"><a class="site-name" href="/">dasdom</a><nav><ul><li><a class="selected" href="/posts">Posts</a></li><li><a href="/books">Books</a></li><li><a href="/about">About</a></li><li><a href="/imprint">Imprint</a></li><li><a href="/privacy">Privacy</a></li></ul></nav></div></header><div class="wrapper"><p>6. Jun 2020</p><article><div class="content"><h1>Testing a Custom UICollectionViewCompositionalLayout.list</h1><p>In iOS 14 Apple added a collection view compositional layout that lets us create collection views that look and behave like <code>UITableView</code>s. It is based on UICollectionViewCompositionalLayout and as a result allows to create very complex collection view layouts with only little code.</p><p>I believe that we should test our view controllers. For example I often write tests that assure that setting up a table view cell works as intended. An example for such a test looks like this:</p><pre><code><span class="keyword">func</span> test_cellForRow_populatesCell() {
  <span class="comment">// given</span>
  sut.<span class="property">names</span> = [<span class="string">"foo"</span>]
  
  <span class="comment">// when</span>
  <span class="keyword">let</span> indexPath = <span class="type">IndexPath</span>(row: <span class="number">0</span>, section: <span class="number">0</span>)
  <span class="keyword">let</span> cell = tableView.<span class="property">dataSource</span>?.<span class="call">tableView</span>(tableView, cellForRowAt: indexPath)
  
  <span class="comment">// then</span>
  <span class="call">XCTAssertEqual</span>(cell?.<span class="property">textLabel</span>?.<span class="property">text</span>, sut.<span class="property">names</span>.<span class="property">first</span>)
}
</code></pre><p>(This code is taken from my book <a href="https://leanpub.com/tdd_ios_gimme_the_code">Test-Driven iOS Development - Gimme The Code</a>).</p><p>Testing the population of a table view cell is quite easy. We setup the data source, get the cell from it and assert that the relevant data is set to the label in the cell.</p><p>The list layout in <code>UICollectionViewCompositionalLayout</code> works quite differently. I don't want to go into detail in this post how you can setup a collection view with the new list layout. Let's safe that for a later post. All you need to know is that you setup a <code>UICellConfigurationState</code> and tell the cell that it needs to update it's configuration. The cell then calls the method <code>updateConfiguration(using:)</code> and you override that method to setup the cell.</p><p>You can see how this works in <code>CustomCellListViewController.swift</code> in the sample code provided by Apple <a href="https://developer.apple.com/documentation/uikit/views_and_controls/collection_views/implementing_modern_collection_views">here</a>.</p><p>When I tried to write a test for this, I ran into the problem that <code>updateConfiguration(using:)</code> is called after my test is finished. <s>So it looks like to me that UIKit postpones the call onto the next run loop. This means to be able to test the population of the collection view cell, I needed move the assertion to the next run loop as well.</s> The Apple engineer <a href="https://twitter.com/_mochs">@_mochs</a> answered to my posts, that it should be sufficient to call <code>layoutIfNeeded</code> on the cell to trigger populating the cell.</p><p>So, this works:</p><pre><code><span class="keyword">func</span> test_cellForItem_returnsConfiguresCell() {
    <span class="keyword">let</span> item = <span class="type">Item</span>(category: .<span class="dotAccess">music</span>, title: <span class="string">"Foo"</span>, description: <span class="string">"Bar"</span>)
    sut.<span class="property">items</span> = [item]
    sut.<span class="call">loadViewIfNeeded</span>()

    <span class="keyword">let</span> indexPath = <span class="type">IndexPath</span>(item: <span class="number">0</span>, section: <span class="number">0</span>)
    <span class="keyword">let</span> cell = collectionView.<span class="property">dataSource</span>?.<span class="call">collectionView</span>(collectionView, cellForItemAt: indexPath) <span class="keyword">as</span>! <span class="type">CustomListCell</span>

    <span class="keyword">let</span> listContentConfiguration = cell.<span class="property">listContentView</span>.<span class="property">configuration</span> <span class="keyword">as</span>! <span class="type">UIListContentConfiguration</span>
    <span class="call">XCTAssertEqual</span>(listContentConfiguration.<span class="property">text</span>, item.<span class="property">title</span>)
}
</code></pre><p>By the way, this is a test for the sample code provided by Apple. I've added tests to better understand what's going on.</p><p>Do you know a better way to test this? How would you test that the collection view cell in the list layout is populated properly?</p><p>If you have questions or remarks about this post, please let me know on Twitter: <a href="https://twitter.com/dasdom">@dasdom</a>.</p></div><span>Tagged with: </span><ul class="tag-list"><li><a href="/tags/uicollectionview">UICollectionView</a></li><li><a href="/tags/uicollectionviewcompositionallayout">UICollectionViewCompositionalLayout</a></li></ul></article></div><footer><p><a href="https://www.buymeacoffee.com/dasdom">Buy me a coffee</a></p><p><a href="/feed.rss">RSS feed</a><a> | </a><a href="https://twitter.com/dasdom">Twitter</a><a> | </a><a href="https://stackoverflow.com/users/498796/dasdom">StackOverflow</a><a> | </a><a href="https://github.com/dasdom">Github</a><a> | </a><a href="https://pragprog.com/titles/dhios/">My Book</a></p><p>Generated using <a href="https://github.com/johnsundell/publish">Publish</a></p></footer></body></html>